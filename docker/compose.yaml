# LLVM_VERSION=20 NODE_VERSION=22.5.1 V8_TARGET=arm64.debug V8_VERSION=12.8.20 docker compose --parallel=1 --progress=plain build

# Tips:
# https://containers.dev/implementors/spec/#devcontainerjson
# https://ddanilov.me/dockerized-cpp-build-with-vscode

services:
  depot_tools:
    image: isolated-vm/depot_tools
    build:
      additional_contexts:
        - debian=docker-image://debian:experimental-20240812
      dockerfile: Dockerfile.depot_tools

  gn_alpine:
    image: isolated-vm/gn_alpine
    build:
      additional_contexts:
        - alpine=docker-image://alpine:edge
      args:
        LLVM_VERSION: ${LLVM_VERSION}
      dockerfile: Dockerfile.gn_alpine

  v8_sources:
    image: isolated-vm/v8_sources:${V8_VERSION}
    build:
      args:
        REF: ${V8_VERSION}
      dockerfile: Dockerfile.v8_sources

  v8_synced:
    image: isolated-vm/v8_synced:${V8_VERSION}
    build:
      additional_contexts:
        - patches=../patches
        - scripts=../scripts
        - isolated-vm/v8_sources=docker-image://isolated-vm/v8_sources:${V8_VERSION}
      args:
        REF: ${V8_VERSION}
      dockerfile: Dockerfile.v8_synced

  v8:
    image: isolated-vm/v8:${V8_TARGET}-${V8_VERSION}
    build:
      additional_contexts:
        - patches=../patches
        - scripts=../scripts
        - debian=docker-image://isolated-vm/depot_tools
        - isolated-vm/v8_sources=docker-image://isolated-vm/v8_sources:${V8_VERSION}
      args:
        REF: ${V8_VERSION}
        TARGET: ${V8_TARGET}
      dockerfile: Dockerfile.v8

  v8_alpine:
    image: isolated-vm/v8_alpine:${V8_TARGET}-${V8_VERSION}
    build:
      additional_contexts:
        - scripts=../scripts
        - isolated-vm/v8_synced=docker-image://isolated-vm/v8_synced:${V8_VERSION}
      args:
        REF: ${V8_VERSION}
        TARGET: linux-musl.${V8_TARGET}
      dockerfile: Dockerfile.v8_alpine

  node_sources:
    image: isolated-vm/node_sources:${NODE_VERSION}
    build:
      args:
        REF: v${NODE_VERSION}
      dockerfile: Dockerfile.node_sources

  node:
    image: isolated-vm/node:${NODE_VERSION}
    build:
      additional_contexts:
        - debian=docker-image://debian:experimental-20240812
        - isolated-vm/node_sources=docker-image://isolated-vm/node_sources:${NODE_VERSION}
        - scripts=../scripts
      dockerfile: Dockerfile.node

  development:
    image: isolated-vm/development
    build:
      additional_contexts:
        - debian=docker-image://isolated-vm/depot_tools
        - isolated-vm/node_sources=docker-image://isolated-vm/node_sources:${NODE_VERSION}
        - isolated-vm/node=docker-image://isolated-vm/node:${NODE_VERSION}
        - isolated-vm/v8_sources=docker-image://isolated-vm/v8_sources:${V8_VERSION}
        - isolated-vm/v8=docker-image://isolated-vm/v8:${V8_TARGET}-${V8_VERSION}
      args:
        LLVM_VERSION: ${LLVM_VERSION}
      dockerfile: Dockerfile.development

{
	"version": "2.0.0",
	"options": {
		"env": {
			"ENV_FILE": "${workspaceFolder}/.env",
			"PATH": "${workspaceFolder}/scripts:${env:PATH}",
		},
	},
	"inputs": [
    {
      "type": "pickString",
      "id": "ivm_target",
      "description": "Which ivm target configuration?",
      "options": [
        "Debug",
        "Release",
        "RelWithDebInfo",
      ],
      "default": "Debug",
    },
    {
      "type": "pickString",
      "id": "v8_target",
      "description": "Which v8 target to build?",
      "options": [
        "debug",
        "optdebug",
        "release",
      ],
      "default": "debug",
    },
    {
      "type": "pickString",
      "id": "v8_version",
      "description": "Which v8 revision to checkout?",
      // pick from: https://chromiumdash.appspot.com/releases
      // (click the "i" icon)
      "options": [
        "14.2.231.21",
        "14.1.146.11",
        "14.0.365.10",
        "13.9.205.21",
        "13.8.258.30",
        "13.7.152.17",
        "13.6.233.10",
        "13.5.212.10",
      ],
      "default": "14.2.231.21",
    },
    {
      "type": "pickString",
      "id": "nodejs_version",
      "description": "Which nodejs version to link against? For debug builds of isolated-vm the headers must match the nodejs version.",
      "options": [
        "24.0.0",
        "22.0.0",
        "20.0.0",
      ],
      "default": "24.0.0",
    },
	],
	"tasks": [
		{
			"label": "isolated-vm: build",
			"group": {
				"kind": "build",
				"isDefault": true
			},
			"dependsOn": [ "tsc: watch", "ninja: build" ],
			"icon": { "id": "plug" },
		},
		{
			"label": "tsc: watch",
			"type": "shell",
			"command": "npx tsc --build --watch",
			"problemMatcher": "$tsc-watch",
			"isBackground": true,
			"presentation": {
				"panel": "dedicated",
				"reveal": "never",
			},
			"group": "build",
			"icon": { "id": "zap" },
		},
		{
			"label": "cmake: clean",
			"type": "shell",
			"command": "rm -rf build",
			"problemMatcher": [],
			"presentation": {
				"close": true,
				"reveal": "never",
			},
			"icon": { "id": "jersey" },
		},
		{
			"label": "cmake: configure",
			"type": "shell",
			// nb: `-DENV=$ENV` used to "burn in" environment variables at configure time. So when the
			// build configuration changes, ninja can reconfigure correctly.
			"command": "set -eu; set -a; source $ENV_FILE; source $V8_LIBRARY_PATH/env; cmake -DCMAKE_BUILD_TYPE=${input:ivm_target} -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DIVM_INSTALL=link -DNODE_DIST_DIR=\"$NODE_DIST_DIR\" -DV8_INCLUDE_DIR=\"$V8_INCLUDE_DIR\" -DV8_INCLUDE_GN_FILE=\"$V8_INCLUDE_GN_FILE\" -DV8_LIBRARY_TYPE=\"$V8_LIBRARY_TYPE\" -DV8_LIBRARY_PATH=\"$V8_LIBRARY_PATH\" -G Ninja -B build",
			"dependsOn": [ "cmake: clean" ],
			"problemMatcher": [],
			"presentation": {
				"clear": true,
				"panel": "dedicated",
				"reveal": "silent",
				"showReuseMessage": false,
			},
			"icon": { "id": "wrench" },
		},
		{
			"label": "ninja: build",
			"type": "shell",
			"command": "set -eu; ninja -C build backend_napi_v8",
			"problemMatcher": "$gcc",
			"presentation": {
				"clear": true,
				"panel": "dedicated",
				"reveal": "never",
				"showReuseMessage": false,
			},
			"group": "build",
			"icon": { "id": "flame" },
		},
		{
			"label": "v8: select",
			"type": "shell",
			"command": "set -eu; export V8_REF=$(PATCH_DIR=${workspaceFolder}/patches v8_select ${input:v8_version}); ivm_write_env V8_REF",
			"options": { "cwd": "/v8" },
			"problemMatcher": [],
			"presentation": {
				"reveal": "silent",
			},
			"icon": { "id": "versions" },
		},
		{
			"label": "v8: build",
			"type": "shell",
			"command": "unset CLANG_BASE_PATH; set -eu; set -a; source $ENV_FILE; TARGET=$(triplet_util %t.${input:v8_target}); export V8_LIBRARY_PATH=\"$(pwd)/out/$V8_REF/$TARGET\"; WITHOUT_SYSROOT=1 v8_build \"$V8_LIBRARY_PATH\"; ivm_write_env V8_LIBRARY_PATH",
			"options": { "cwd": "/v8" },
			"problemMatcher": [],
			"presentation": {
				"reveal": "always",
			},
			"icon": { "id": "library" },
		},
		{
			"label": "nodejs: select",
			"type": "shell",
			"command": "set -eu; export NODE_DIST_DIR=$(nodejs_select ~/local/nodejs/${input:nodejs_version}); ivm_write_env NODE_DIST_DIR",
			"options": { "cwd": "${userHome}" },
			"problemMatcher": [],
			"presentation": {
				"reveal": "silent",
			},
			"icon": { "id": "versions" },
		},
	],
}
